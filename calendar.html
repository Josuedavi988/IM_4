<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FitUp – Kalender</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container" style="background-color: #4a5d80; padding: 16px;">

    <!-- Fortschrittsbalken ganz oben -->
    <div id="level-progress-bar" style="margin-bottom: 24px;"></div>

    <div class="header">
      <h1 class="logo">FitUp</h1>
      <a href="profile.html" class="profile-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </a>
    </div>

    <div class="weekday-tabs" id="weekdayTabs"></div>
    <div class="activity-list" id="activityList"></div>
    <a href="start.html" class="button" style="margin-top: 24px;">zurück</a>
  </div>

  <script>
    const weekdayTabs = document.getElementById("weekdayTabs");
    const activityList = document.getElementById("activityList");
    const progressBarDiv = document.getElementById("level-progress-bar");

    // Heute + 5 Tage
    const days = [];
    const today = new Date();
    for (let i = 0; i < 6; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      days.push(date);
    }

    let selectedDate = days[0].toISOString().split("T")[0];

    function renderTabs() {
      weekdayTabs.innerHTML = "";
      days.forEach((date, index) => {
        const dayName = date.toLocaleDateString("de-CH", { weekday: "short" });
        const dayNumber = date.getDate();
        const dateString = date.toISOString().split("T")[0];

        const btn = document.createElement("button");
        btn.className = "weekday-tab" + (index === 0 ? " active" : "");
        btn.innerHTML = `<span class="weekday-day">${dayName}</span><span class="weekday-date">${dayNumber}</span>`;
        btn.addEventListener("click", () => {
          document.querySelectorAll(".weekday-tab").forEach(t => t.classList.remove("active"));
          btn.classList.add("active");
          selectedDate = dateString;
          renderActivities();
        });
        weekdayTabs.appendChild(btn);
      });
    }

    let activitiesByDate = {};

    function renderActivities() {
      activityList.innerHTML = "";
      const activities = activitiesByDate[selectedDate] || [];
      if (activities.length === 0) {
        activityList.innerHTML = "<p style='color: white; text-align: center;'>Keine Aktivitäten</p>";
        return;
      }

      activities.forEach(activity => {
        const minuten = Math.floor(activity.duration / 60);
        const sekunden = activity.duration % 60;
        const score = Math.floor(activity.duration / 10);

        const div = document.createElement("div");
        div.className = "activity-item";
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.backgroundColor = "#334155";
        div.style.borderRadius = "12px";
        div.style.padding = "12px";
        div.style.marginBottom = "12px";
        div.style.color = "white";

        div.innerHTML = `
          <div class="activity-icon" style="margin-right: 12px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 6v6l4 2" />
            </svg>
          </div>
          <div class="activity-details">
            <div class="activity-title" style="font-weight: bold;">${activity.type}</div>
            <div class="activity-info">${minuten} min ${sekunden} sek</div>
            <div class="activity-info">Score: ${score}</div>
          </div>
        `;
        activityList.appendChild(div);
      });
    }

    function berechneLevelFortschritt(totalSeconds) {
      let level = 0;
      let requiredScore = 360; // 360 Sekunden = Score 36
      let nextLevelScore = 360;
      let totalScore = Math.floor(totalSeconds / 10);

      while (totalScore >= requiredScore) {
        level++;
        nextLevelScore = Math.floor(nextLevelScore * 1.5);
        requiredScore += nextLevelScore;
      }

      const restScore = totalScore - (requiredScore - nextLevelScore);
      const progress = Math.floor((restScore / nextLevelScore) * 100);
      const fehltScore = nextLevelScore - restScore;

      return {
        level,
        progress,
        fehltScore,
        totalScore
      };
    }

    function zeigeFortschrittBalken(fortschritt) {
      progressBarDiv.innerHTML = `
        <div style="color: white; font-weight: bold; text-align: center;">Level: ${fortschritt.level}</div>
        <div style="color: white; text-align: center;">Noch ${fortschritt.fehltScore} Punkte bis Level ${fortschritt.level + 1}</div>
        <div style="background: #334155; height: 12px; border-radius: 6px; margin: 8px 24px; overflow: hidden;">
          <div style="height: 100%; width: ${fortschritt.progress}%; background: #38bdf8;"></div>
        </div>
      `;
    }

    fetch("system/api/get-activities.php")
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          activitiesByDate = data.data;
          renderTabs();
          renderActivities();

          const alle = Object.values(activitiesByDate).flat();
          const totalSeconds = alle.reduce((sum, a) => sum + a.duration, 0);
          const fortschritt = berechneLevelFortschritt(totalSeconds);
          zeigeFortschrittBalken(fortschritt);
        } else {
          activityList.innerHTML = "<p style='color: white;'>Fehler beim Laden</p>";
        }
      })
      .catch(err => {
        console.error("Fehler beim Laden:", err);
        activityList.innerHTML = "<p style='color: white;'>Verbindungsfehler</p>";
      });
  </script>
</body>
</html>
